<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>성가 2015</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4b0082" />
  <link rel="icon" href="icon-192.png" />

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 12px;
    }

    /* 상단 툴바: 한 줄 유지 */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;      /* 절대 줄바꿈 X */
      overflow: hidden;       /* 아주 작은 화면에서도 줄바꿈 대신 폭만 줄임 */
    }
    .toolbar button {
      padding: 6px 10px;
      margin: 0;
      flex: 0 0 auto;         /* 버튼은 줄어들지 않음 */
      min-width: 36px;        /* 터치 영역 최소 확보 */
    }
    #searchInput {
      padding: 6px 8px;
      font-size: 1em;
      border: 1px solid #ccc;
      flex: 1 1 0;            /* 입력칸이 유연하게 폭 차지 */
      min-width: 80px;        /* 너무 작아지지 않게 */
    }

    #pdfViewer {
      margin-top: 16px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }

    canvas {
      display: inline-block;
      max-width: 100%;
      height: auto;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }

    #bookmarkPopup {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #888;
      padding: 20px 30px 20px 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      z-index: 999;
      min-width: 250px;
    }
    #bookmarkPopup .closeBtn {
      position: absolute;
      top: 8px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }
    .bookmark-entry {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .bookmark-entry input {
      width: 90px;
      padding: 6px;
      font-size: 1em;
      text-align: center;
      border: 1px solid #ccc;
    }
    .bookmark-entry button {
      margin-left: 6px;
      padding: 6px 10px;
      font-size: 0.9em;
      white-space: nowrap;
      min-width: 55px;
    }
    .bookmark-entry button.save-btn { background-color: #d0e0ff; border: 1px solid #a0c0ff; }
    .bookmark-entry button.delete-btn { background-color: #f0d0d0; border: 1px solid #e0a0a0; }
    .bookmark-entry button.search-btn { background-color: #aaccee; border: 1px solid #6699cc; font-weight: bold; }

    /* 밑으로 스와이프시 화면갱신 방지 */
    html, body { overscroll-behavior: contain; }

    /* 아주 작은 화면에서 터치 여유를 조금 더 */
    @media (max-width: 360px) {
      .toolbar button { min-width: 32px; padding: 6px 8px; }
      #searchInput { min-width: 60px; }
    }
  </style>
</head>
<body>

  <!-- ✅ 한 줄 툴바: [<] [입력칸] [>] [책갈피] -->
  <div class="toolbar">
    <button aria-label="이전 성가" onclick="stepHymn(-1)">‹</button>
    <input id="searchInput" type="text" onkeydown="if (event.key === 'Enter') searchHymn()">
    <button aria-label="다음 성가" onclick="stepHymn(1)">›</button>
    <button onclick="openBookmarkPopup()">📌 책갈피</button>
  </div>

  <div id="bookmarkPopup">
    <button class="closeBtn" onclick="closeBookmarkPopup()">✖</button>
    <h3 style="margin-top: 0;">📌 오늘의 성가</h3>
    <div id="bookmarkList"></div>
  </div>

  <div id="pdfViewer" style="text-align:center; color:#777; font-size:1.1em; padding:30px;">
  🎵 성가번호나 제목을 입력하고 엔터키를 누르세요
  </div>

  <script src="pdfjs/pdf.js"></script>

  <script>

  window.addEventListener('error', e => alert('JS Error: ' + (e.message || e)));
  window.addEventListener('unhandledrejection', e => alert('Promise Error: ' + (e.reason && e.reason.message || e.reason)));


    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker
          .register("/khymn/service-worker.js")
          .then(function (registration) {
            console.log("✅ Service Worker 등록 성공:", registration.scope);
          })
          .catch(function (error) {
            console.error("❌ Service Worker 등록 실패:", error);
          });
      });
    }

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';

    /* 밑으로 스와이프시 화면갱신 방지 */
    let touchStartY = 0;
    let isOneFinger = false;
    window.addEventListener("touchstart", function (e) {
      isOneFinger = e.touches.length === 1;
      if (isOneFinger) touchStartY = e.touches[0].clientY;
    }, { passive: true });
    window.addEventListener("touchmove", function (e) {
      if (!isOneFinger) return;
      const currentY = e.touches[0].clientY;
      if (window.scrollY === 0 && currentY > touchStartY + 10) {
        e.preventDefault();
      }
    }, { passive: false });

    let pdfDoc = null;
    let hymnIndex = [];
    let bookmarks = [];
    let lastShownNumber = null; // ✅ 최근에 표시한 성가번호

    pdfjsLib.getDocument("hymnbook.pdf").promise.then(doc => {
      pdfDoc = doc;
    });

    fetch("hymn-index-final.json")
      .then(res => res.json())
      .then(data => {
        hymnIndex = data;
      });

    function hymnExists(num) {
      return hymnIndex.some(i

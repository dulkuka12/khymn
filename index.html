<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì„±ê°€ 2015</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4b0082" />
  <link rel="icon" href="icon-192.png" />

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 12px;
    }

    /* â”€â”€ ìƒë‹¨ íˆ´ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toolbar {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    }
    #searchInput {
      padding: 6px 8px;
      font-size: 1em;
      width: 130px;
      border: 1px solid #ccc;
    }
    button { padding: 6px 10px; margin: 0 4px; }
    .icon-btn {
      display:inline-flex; align-items:center; justify-content:center;
      width: 36px; height: 36px; padding: 0; border: 1px solid #ccc; background:#fff;
      border-radius: 6px; cursor:pointer;
    }
    .icon-btn:disabled { opacity:.4; cursor: not-allowed; }
    .icon-btn svg { width: 20px; height: 20px; }

    /* â”€â”€ PDF ì˜ì—­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #pdfViewer {
      margin-top: 16px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
      position: relative;
      min-height: 120px;
    }
    canvas {
      display: inline-block;
      max-width: 100%;
      height: auto;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }
    #pdfHint {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font-size:.95em; opacity:.7; padding: 12px;
    }

    /* â”€â”€ ì±…ê°ˆí”¼ íŒì—… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #bookmarkPopup {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #888;
      padding: 20px 30px 20px 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      z-index: 999;
      min-width: 250px;
    }
    #bookmarkPopup .closeBtn {
      position: absolute;
      top: 8px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }
    .bookmark-entry {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .bookmark-entry input {
      width: 90px;
      padding: 6px;
      font-size: 1em;
      text-align: center;
      border: 1px solid #ccc;
    }
    .bookmark-entry button {
      margin-left: 6px;
      padding: 6px 10px;
      font-size: 0.9em;
      white-space: nowrap;
      min-width: 55px;
    }
    .bookmark-entry button.save-btn {
      background-color: #d0e0ff; border: 1px solid #a0c0ff;
    }
    .bookmark-entry button.delete-btn {
      background-color: #f0d0d0; border: 1px solid #e0a0a0;
    }
    .bookmark-entry button.search-btn {
      background-color: #aaccee; border: 1px solid #6699cc; font-weight: bold;
    }

    /* ë°‘ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ì‹œ í™”ë©´ê°±ì‹  ë°©ì§€ */
    html, body { overscroll-behavior: contain; }
  </style>
</head>
<body>

  <!-- â”€â”€ ìƒë‹¨ íˆ´ë°”: â† (ì´ë¯¸ì§€)  ì…ë ¥ì¹¸  â†’ (ì´ë¯¸ì§€)  ì±…ê°ˆí”¼ â”€â”€ -->
  <div class="toolbar">
    <button id="btnPrev" class="icon-btn" onclick="goPrev()" aria-label="ì´ì „">
      <!-- Left arrow (SVG ì´ë¯¸ì§€) -->
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>

    <input id="searchInput" type="text" placeholder="ì¥ìˆ˜ë‚˜ ì œëª© ì…ë ¥"
           onkeydown="if (event.key === 'Enter') searchHymn()">

    <button id="btnNext" class="icon-btn" onclick="goNext()" aria-label="ë‹¤ìŒ">
      <!-- Right arrow (SVG ì´ë¯¸ì§€) -->
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="m10 6-1.41 1.41L13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
    </button>

    <button onclick="openBookmarkPopup()">ğŸ“Œ ì±…ê°ˆí”¼</button>
  </div>

  <!-- ì±…ê°ˆí”¼ íŒì—… -->
  <div id="bookmarkPopup">
    <button class="closeBtn" onclick="closeBookmarkPopup()">âœ–</button>
    <h3 style="margin-top: 0;">ğŸ“Œ ì˜¤ëŠ˜ì˜ ì„±ê°€</h3>
    <div id="bookmarkList"></div>
  </div>

  <!-- PDF ë·°ì–´ + ì´ˆê¸° ì•ˆë‚´ë¬¸ -->
  <div id="pdfViewer">
    <div id="pdfHint">ì„±ê°€ë²ˆí˜¸ë‚˜ ì œëª©ì„ ì…ë ¥í•˜ê³  <b>Enter</b> í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”</div>
  </div>

  <!-- pdf.js -->
  <script src="pdfjs/pdf.js"></script>

  <script>
    // â”€â”€ Service Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker
          .register("/khymn/service-worker.js")
          .then(reg => console.log("âœ… Service Worker ë“±ë¡ ì„±ê³µ:", reg.scope))
          .catch(err => console.error("âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:", err));
      });
    }
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';

    // â”€â”€ ë°‘ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ì‹œ í™”ë©´ê°±ì‹  ë°©ì§€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let touchStartY = 0, isOneFinger = false;
    window.addEventListener("touchstart", e => {
      isOneFinger = e.touches.length === 1;
      if (isOneFinger) touchStartY = e.touches[0].clientY;
    }, { passive: true });
    window.addEventListener("touchmove", e => {
      if (!isOneFinger) return;
      const currentY = e.touches[0].clientY;
      if (window.scrollY === 0 && currentY > touchStartY + 10) e.preventDefault();
    }, { passive: false });

    // â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let pdfDoc = null;
    let hymnIndex = [];   // [{ number: 101, title: '...', page: 23 }, ...] ê°€ì •
    let bookmarks = [];
    let currentIndex = -1; // hymnIndex ë‚´ í˜„ì¬ ì„ íƒ ì¸ë±ìŠ¤
    const norm = s => s?.toString().toLowerCase().replace(/\s+/g, '') ?? '';

    // â”€â”€ PDF/ì¸ë±ìŠ¤ ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    pdfjsLib.getDocument("hymnbook.pdf").promise.then(doc => { pdfDoc = doc; });
    fetch("hymn-index-final.json").then(r => r.json()).then(d => { hymnIndex = d || []; updatePrevNextButtons(); });

    // â”€â”€ ê³µí†µ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPages(startPage, endPage) {
      const viewer = document.getElementById("pdfViewer");
      const hint = document.getElementById("pdfHint");
      if (hint) hint.style.display = "none";

      viewer.innerHTML = ''; // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
      for (let pageNum = startPage; pageNum <= endPage; pageNum++) {
        pdfDoc.getPage(pageNum).then(page => {
          const scale = 1.6;
          const viewport = page.getViewport({ scale });
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          page.render({ canvasContext: context, viewport });
          viewer.appendChild(canvas);
        });
      }
      updatePrevNextButtons();
    }

    // í˜„ì¬ ê³¡ ì¸ë±ìŠ¤ë¥¼ ië¡œ ì„¤ì • + ì…ë ¥ì¹¸ì€ â€˜ì¥ë²ˆí˜¸â€™ë¡œ ê°•ì œ í‘œì‹œ + í˜ì´ì§€ ë Œë”
    function setCurrentByIndex(i) {
      if (i < 0 || i >= hymnIndex.length) return;
      currentIndex = i;

      const item = hymnIndex[i];
      const input = document.getElementById("searchInput");
      if (input) input.value = (item.number ?? item.title ?? "").toString(); // â† ì¥ë²ˆí˜¸ë¡œ í‘œì‹œ

      const startPage = item.page;
      // ë‹¤ìŒ í•­ëª©ì˜ ì‹œì‘ í˜ì´ì§€ ì§ì „ê¹Œì§€ë¥¼ endPageë¡œ
      let endPage = pdfDoc ? pdfDoc.numPages : startPage;
      for (let j = i + 1; j < hymnIndex.length; j++) {
        if (hymnIndex[j].page > startPage) { endPage = hymnIndex[j].page - 1; break; }
      }
      if (pdfDoc) renderPages(startPage, endPage);
    }

    // ì…ë ¥ì¹¸ì„ ë³´ê³  currentIndexê°€ ì—†ìœ¼ë©´ ì°¾ì•„ì„œ ì„¸íŒ… (ìˆ«ìë©´ number, ì•„ë‹ˆë©´ title ë¶€ë¶„ì¼ì¹˜)
    function ensureCurrentIndex() {
      if (currentIndex >= 0) return currentIndex;
      const inputEl = document.getElementById("searchInput");
      if (!inputEl) return -1;

      const raw = inputEl.value.trim();
      if (!raw) return -1;

      const isNum = /^\d+$/.test(raw);
      let found = -1;

      if (isNum) {
        found = hymnIndex.findIndex(x => String(x.number) === raw);
      } else {
        const target = norm(raw);
        found = hymnIndex.findIndex(x => x.title && norm(x.title).includes(target));
      }
      if (found >= 0) currentIndex = found;
      return currentIndex;
    }

    // â† / â†’ ë²„íŠ¼: ì œëª©ì´ ì¨ìˆë“  ë­ë“  ëˆ„ë¥´ë©´ ì¥ë²ˆí˜¸ë¡œ ì „í™˜ + ì´ë™
    function goPrev() {
      const idx = ensureCurrentIndex();
      if (idx > 0) setCurrentByIndex(idx - 1);
      updatePrevNextButtons();
    }
    function goNext() {
      const idx = ensureCurrentIndex();
      if (idx >= 0 && idx < hymnIndex.length - 1) setCurrentByIndex(idx + 1);
      updatePrevNextButtons();
    }

    function updatePrevNextButtons() {
      const prev = document.getElementById("btnPrev");
      const next = document.getElementById("btnNext");
      const has = currentIndex >= 0;
      if (prev) prev.disabled = !has || currentIndex === 0;
      if (next) next.disabled = !has || currentIndex === hymnIndex.length - 1;
    }

    // â”€â”€ ê²€ìƒ‰/ì í”„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function searchHymn() {
      const inputRaw = document.getElementById("searchInput").value.trim();
      const input = inputRaw.toLowerCase().replace(/\s+/g, "");
      if (!input || !pdfDoc || hymnIndex.length === 0) return;

      const matchIndex = hymnIndex.findIndex(item => {
        const numberMatch = item.number.toString() === input;
        const titleMatch = item.title.replace(/\s+/g, "").toLowerCase().includes(input);
        return numberMatch || (!/^\d+$/.test(input) && titleMatch);
      });

      if (matchIndex === -1) {
        alert("âŒ í•´ë‹¹ ì„±ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      setCurrentByIndex(matchIndex); // ì—¬ê¸°ì„œ ì…ë ¥ì¹¸ì„ ì¥ë²ˆí˜¸ë¡œ ë™ê¸°í™” + ë Œë”
    }

    function jumpToHymn(numStr) {
      const matchIndex = hymnIndex.findIndex(item => item.number.toString() === numStr);
      if (matchIndex === -1) { alert("âŒ í•´ë‹¹ ì„±ê°€ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      setCurrentByIndex(matchIndex);
    }

    // â”€â”€ ì±…ê°ˆí”¼ íŒì—… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openBookmarkPopup() {
      loadBookmarks(); updateBookmarkList();
      document.getElementById("bookmarkPopup").style.display = "block";
    }
    function closeBookmarkPopup() {
      document.getElementById("bookmarkPopup").style.display = "none";
    }
    function updateBookmarkList() {
      const container = document.getElementById("bookmarkList");
      container.innerHTML = '';
      for (let i = 0; i < 5; i++) {
        const value = bookmarks[i] || "";
        container.innerHTML += `
          <div class="bookmark-entry">
            <input id="bmInput${i}" type="text" inputmode="numeric" maxlength="3" placeholder="ì„±ê°€ë²ˆí˜¸" value="${value}">
            <button onclick="saveBookmark(${i})" class="save-btn">ì €ì¥</button>
            <button onclick="deleteBookmark(${i})" class="delete-btn">ì‚­ì œ</button>
            <button onclick="searchFromBookmark(${i})" class="search-btn">ê²€ìƒ‰</button>
          </div>`;
      }
    }
    function saveBookmark(index) {
      const input = document.getElementById(\`bmInput\${index}\`);
      const val = input.value.trim();
      if (/^\d{1,3}$/.test(val)) {
        bookmarks[index] = val; saveBookmarks(); updateBookmarkList();
      }
    }
    function deleteBookmark(index) { bookmarks[index] = ""; saveBookmarks(); updateBookmarkList(); }
    function searchFromBookmark(index) {
      const val = document.getElementById(\`bmInput\${index}\`).value.trim();
      if (val) jumpToHymn(val); else alert("ğŸ” ê²€ìƒ‰í•  ì„±ê°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    }
    function saveBookmarks() { localStorage.setItem("hymnBookmarks", JSON.stringify(bookmarks)); }
    function loadBookmarks() {
      const saved = localStorage.getItem("hymnBookmarks");
      if (saved) bookmarks = JSON.parse(saved);
    }
    window.addEventListener('load', loadBookmarks);
  </script>
</body>
</html>

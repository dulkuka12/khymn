<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>성가 검색 (전체 PDF)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 12px;
    }

    h2 {
      font-size: 1.2em;
      margin: 0;
      display: inline-block;
    }

    #searchInput {
      padding: 6px 10px;
      font-size: 1em;
      width: 160px;
      margin-left: 10px;
    }

    button {
      padding: 6px 10px;
      margin: 0 4px;
    }

    #pdfViewer {
      margin-top: 16px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }

    canvas {
      display: inline-block;
      max-width: 100%;
      height: auto;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }

    #bookmarkPopup {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #888;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      z-index: 999;
    }

    #bookmarkPopup input {
      margin-bottom: 6px;
    }
  </style>
</head>

<body>
  <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <h2>📖 성가 검색</h2>
    <input id="searchInput" type="text" placeholder="장수나 제목 입력" onkeydown="if (event.key === 'Enter') searchHymn()">
  </div>

  <div style="margin-top: 10px; margin-bottom: 10px;">
    <button onclick="goToPreviousPage()">⬅️ 이전 페이지</button>
    <button onclick="goToNextPage()">다음 페이지 ➡️</button>
    <button onclick="openBookmarkPopup()">📌 책갈피</button>
  </div>

  <div id="bookmarkPopup">
    <h3>📌 오늘의 성가</h3>
    <div id="bookmarkList"></div>
    <div style="margin-top:10px;">
      <input id="newBookmark" placeholder="장수 입력">
      <button onclick="addBookmark()">추가</button>
      <button onclick="clearBookmarks()">모두 지우기</button>
      <button onclick="closeBookmarkPopup()">닫기</button>
    </div>
  </div>

  <div id="pdfViewer">
    <canvas id="pdfCanvas"></canvas>
  </div>

  <script>
    let pdfDoc = null;
    let hymnIndex = [];
    let currentPage = 1;
    let bookmarks = [];

    pdfjsLib.getDocument("hymnbook.pdf").promise.then(doc => {
      pdfDoc = doc;
      renderPage(currentPage);
    });

    fetch("hymn-index-final.json")
      .then(res => res.json())
      .then(data => {
        hymnIndex = data;
      });

    function searchHymn() {
      const inputRaw = document.getElementById("searchInput").value.trim();
      const input = inputRaw.toLowerCase().replace(/\s+/g, "");

      if (!input || !pdfDoc || hymnIndex.length === 0) return;


      const match = hymnIndex.find(item => {
        const numberMatch = item.number.toString() === input;
        const titleMatch = item.title.replace(/\s+/g, "").toLowerCase().includes(input);
        return numberMatch || (!/^\d+$/.test(input) && titleMatch);
      });


      if (!match) {
        alert("❌ 해당 성가를 찾을 수 없습니다.");
        return;
      }

      currentPage = match.page;
      renderPage(currentPage);
    }

    function renderPage(pageNumber) {
      const canvas = document.getElementById("pdfCanvas");
      const context = canvas.getContext("2d");

      pdfDoc.getPage(pageNumber).then(page => {
        const viewport = page.getViewport({ scale: 1.6 });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        page.render({ canvasContext: context, viewport });
        currentPage = pageNumber;
      });
    }

    function goToPreviousPage() {
      if (currentPage > 1) {
        renderPage(currentPage - 1);
      }
    }

    function goToNextPage() {
      if (currentPage < pdfDoc.numPages) {
        renderPage(currentPage + 1);
      }
    }

    function jumpTo(num) {
      const match = hymnIndex.find(item => item.number.toString() === num.trim());
      if (match) {
        currentPage = match.page;
        renderPage(currentPage);
      } else {
        alert("❌ 해당 장수가 존재하지 않습니다.");
      }
    }

    function openBookmarkPopup() {
      loadBookmarks();
      updateBookmarkList();
      document.getElementById("bookmarkPopup").style.display = "block";
    }

    function closeBookmarkPopup() {
      document.getElementById("bookmarkPopup").style.display = "none";
    }

    function addBookmark() {
      const val = document.getElementById("newBookmark").value.trim();
      if (val && !bookmarks.includes(val) && bookmarks.length < 5) {
        bookmarks.push(val);
        saveBookmarks();
        updateBookmarkList();
        document.getElementById("newBookmark").value = '';
      }
    }

    function clearBookmarks() {
      bookmarks = [];
      localStorage.removeItem("hymnBookmarks");
      updateBookmarkList();
    }

    function updateBookmarkList() {
      const container = document.getElementById("bookmarkList");
      container.innerHTML = bookmarks.map(num => `<button onclick=\"jumpTo('${num}')\">성가 ${num}</button>`).join("<br>");
    }

    function saveBookmarks() {
      localStorage.setItem("hymnBookmarks", JSON.stringify(bookmarks));
    }

    function loadBookmarks() {
      const saved = localStorage.getItem("hymnBookmarks");
      if (saved) {
        bookmarks = JSON.parse(saved);
      }
    }

    window.addEventListener('load', () => {
      loadBookmarks();
    });
  </script>
</body>

</html>
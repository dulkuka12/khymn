<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì„±ê°€ 2015</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4b0082" />
  <link rel="icon" href="icon-192.png" />

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 12px;
    }

    /* ìƒë‹¨ íˆ´ë°”: í•œ ì¤„ ìœ ì§€ */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;      /* ì ˆëŒ€ ì¤„ë°”ê¿ˆ X */
      overflow: hidden;       /* ì•„ì£¼ ì‘ì€ í™”ë©´ì—ì„œë„ ì¤„ë°”ê¿ˆ ëŒ€ì‹  í­ë§Œ ì¤„ì„ */
    }
    .toolbar button {
      padding: 6px 10px;
      margin: 0;
      flex: 0 0 auto;         /* ë²„íŠ¼ì€ ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
      min-width: 36px;        /* í„°ì¹˜ ì˜ì—­ ìµœì†Œ í™•ë³´ */
    }
    #searchInput {
      padding: 6px 8px;
      font-size: 1em;
      border: 1px solid #ccc;
      flex: 1 1 0;            /* ì…ë ¥ì¹¸ì´ ìœ ì—°í•˜ê²Œ í­ ì°¨ì§€ */
      min-width: 80px;        /* ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ */
    }

    #pdfViewer {
      margin-top: 16px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }

    canvas {
      display: inline-block;
      max-width: 100%;
      height: auto;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }

    #bookmarkPopup {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #888;
      padding: 20px 30px 20px 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      z-index: 999;
      min-width: 250px;
    }
    #bookmarkPopup .closeBtn {
      position: absolute;
      top: 8px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }
    .bookmark-entry {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .bookmark-entry input {
      width: 90px;
      padding: 6px;
      font-size: 1em;
      text-align: center;
      border: 1px solid #ccc;
    }
    .bookmark-entry button {
      margin-left: 6px;
      padding: 6px 10px;
      font-size: 0.9em;
      white-space: nowrap;
      min-width: 55px;
    }
    .bookmark-entry button.save-btn { background-color: #d0e0ff; border: 1px solid #a0c0ff; }
    .bookmark-entry button.delete-btn { background-color: #f0d0d0; border: 1px solid #e0a0a0; }
    .bookmark-entry button.search-btn { background-color: #aaccee; border: 1px solid #6699cc; font-weight: bold; }

    /* ë°‘ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ì‹œ í™”ë©´ê°±ì‹  ë°©ì§€ */
    html, body { overscroll-behavior: contain; }

    /* ì•„ì£¼ ì‘ì€ í™”ë©´ì—ì„œ í„°ì¹˜ ì—¬ìœ ë¥¼ ì¡°ê¸ˆ ë” */
    @media (max-width: 360px) {
      .toolbar button { min-width: 32px; padding: 6px 8px; }
      #searchInput { min-width: 60px; }
    }
  </style>
</head>
<body>

  <!-- âœ… í•œ ì¤„ íˆ´ë°”: [<] [ì…ë ¥ì¹¸] [>] [ì±…ê°ˆí”¼] -->
  <div class="toolbar">
    <button aria-label="ì´ì „ ì„±ê°€" onclick="stepHymn(-1)">â€¹</button>
    <input id="searchInput" type="text" onkeydown="if (event.key === 'Enter') searchHymn()">
    <button aria-label="ë‹¤ìŒ ì„±ê°€" onclick="stepHymn(1)">â€º</button>
    <button onclick="openBookmarkPopup()">ğŸ“Œ ì±…ê°ˆí”¼</button>
  </div>

  <div id="bookmarkPopup">
    <button class="closeBtn" onclick="closeBookmarkPopup()">âœ–</button>
    <h3 style="margin-top: 0;">ğŸ“Œ ì˜¤ëŠ˜ì˜ ì„±ê°€</h3>
    <div id="bookmarkList"></div>
  </div>

  <div id="pdfViewer" style="text-align:center; color:#777; font-size:1.1em; padding:30px;">
  ğŸµ ì„±ê°€ë²ˆí˜¸ë‚˜ ì œëª©ì„ ì…ë ¥í•˜ê³  ì—”í„°í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”
  </div>

  <script src="pdfjs/pdf.js"></script>

  <script>

  window.addEventListener('error', e => alert('JS Error: ' + (e.message || e)));
  window.addEventListener('unhandledrejection', e => alert('Promise Error: ' + (e.reason && e.reason.message || e.reason)));


    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker
          .register("/khymn/service-worker.js")
          .then(function (registration) {
            console.log("âœ… Service Worker ë“±ë¡ ì„±ê³µ:", registration.scope);
          })
          .catch(function (error) {
            console.error("âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:", error);
          });
      });
    }

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';

    /* ë°‘ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ì‹œ í™”ë©´ê°±ì‹  ë°©ì§€ */
    let touchStartY = 0;
    let isOneFinger = false;
    window.addEventListener("touchstart", function (e) {
      isOneFinger = e.touches.length === 1;
      if (isOneFinger) touchStartY = e.touches[0].clientY;
    }, { passive: true });
    window.addEventListener("touchmove", function (e) {
      if (!isOneFinger) return;
      const currentY = e.touches[0].clientY;
      if (window.scrollY === 0 && currentY > touchStartY + 10) {
        e.preventDefault();
      }
    }, { passive: false });

    let pdfDoc = null;
    let hymnIndex = [];
    let bookmarks = [];
    let lastShownNumber = null; // âœ… ìµœê·¼ì— í‘œì‹œí•œ ì„±ê°€ë²ˆí˜¸

    pdfjsLib.getDocument("hymnbook.pdf").promise.then(doc => {
      pdfDoc = doc;
    });

    fetch("hymn-index-final.json")
      .then(res => res.json())
      .then(data => {
        hymnIndex = data;
      });

    function hymnExists(num) {
      return hymnIndex.some(i

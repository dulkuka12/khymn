<!DOCTYPE html>
<html lang="ko">

<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>성가 2015</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4b0082" />
  <link rel="icon" href="icon-192.png" />

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 12px;
    }

    #searchInput {
      padding: 6px 8px;
      font-size: 1em;
      width: 130px;
      border: 1px solid #ccc;
    }

    button {
      padding: 6px 10px;
      margin: 0 4px;
    }

    #pdfViewer {
      margin-top: 16px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }

    canvas {
      display: inline-block;
      max-width: 100%;
      height: auto;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }

    #bookmarkPopup {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #888;
      padding: 20px 30px 20px 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      z-index: 999;
      min-width: 250px;
    }

    #bookmarkPopup .closeBtn {
      position: absolute;
      top: 8px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    .bookmark-entry {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .bookmark-entry input {
      width: 90px;
      /* 기존 100px → 약간 축소 */
      padding: 6px;
      font-size: 1em;
      text-align: center;
      border: 1px solid #ccc;
    }

    .bookmark-entry button {
      margin-left: 6px;
      padding: 6px 10px;
      /* 좌우 패딩을 추가하여 너비 확보 */
      font-size: 0.9em;
      white-space: nowrap;
      /* 줄바꿈 방지 */
      min-width: 55px;
      /* 최소 너비 보장 */
    }


    .bookmark-entry button.save-btn {
      background-color: #d0e0ff;
      /* 연한 파랑 */
      border: 1px solid #a0c0ff;
    }

    .bookmark-entry button.delete-btn {
      background-color: #f0d0d0;
      /* 연한 빨강 */
      border: 1px solid #e0a0a0;
    }

    .bookmark-entry button.search-btn {
      background-color: #aaccee;
      /* 약간 진한 파랑 */
      border: 1px solid #6699cc;
      font-weight: bold;
    }


html, body {
  overscroll-behavior: contain;
}




  </style>
</head>

<body>

  <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <label for="searchInput">성가 검색</label>
    <input id="searchInput" type="text" placeholder="장수나 제목 입력" onkeydown="if (event.key === 'Enter') searchHymn()">
    <button onclick="openBookmarkPopup()">📌 책갈피</button>
  </div>


  <div id="bookmarkPopup">
    <button class="closeBtn" onclick="closeBookmarkPopup()">✖</button>
    <h3 style="margin-top: 0;">📌 오늘의 성가</h3>
    <div id="bookmarkList"></div>
  </div>

  <div id="pdfViewer"></div>

  <script src="pdfjs/pdf.js"></script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker
          .register("/khymn/service-worker.js")
          .then(function (registration) {
            console.log("✅ Service Worker 등록 성공:", registration.scope);
          })
          .catch(function (error) {
            console.error("❌ Service Worker 등록 실패:", error);
          });
      });
    }

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';



let touchStartY = 0;
let touchStartX = 0;
let isOneFinger = false;

window.addEventListener("touchstart", function (e) {
  isOneFinger = e.touches.length === 1; // 두 손가락이면 확대 제스처
  if (isOneFinger) {
    touchStartY = e.touches[0].clientY;
    touchStartX = e.touches[0].clientX;
  }
}, { passive: true });

window.addEventListener("touchmove", function (e) {
  if (!isOneFinger) return; // 두 손가락 이상이면 확대 제스처 허용

  const currentY = e.touches[0].clientY;
  const currentX = e.touches[0].clientX;

  // 위로 스크롤 중이면서, 아래로 쓸어내리는 동작일 때
  if (window.scrollY === 0 && currentY > touchStartY + 10) {
    e.preventDefault(); // 새로고침 방지
  }
}, { passive: false });






    let pdfDoc = null;
    let hymnIndex = [];
    let bookmarks = [];

    pdfjsLib.getDocument("hymnbook.pdf").promise.then(doc => {
      pdfDoc = doc;
    });

    fetch("hymn-index-final.json")
      .then(res => res.json())
      .then(data => {
        hymnIndex = data;
      });

    function searchHymn() {
      const inputRaw = document.getElementById("searchInput").value.trim();
      const input = inputRaw.toLowerCase().replace(/\s+/g, "");

      if (!input || !pdfDoc || hymnIndex.length === 0) return;

      const matchIndex = hymnIndex.findIndex(item => {
        const numberMatch = item.number.toString() === input;
        const titleMatch = item.title.replace(/\s+/g, "").toLowerCase().includes(input);
        return numberMatch || (!/^\d+$/.test(input) && titleMatch);
      });

      if (matchIndex === -1) {
        alert("❌ 해당 성가를 찾을 수 없습니다.");
        return;
      }

      const startPage = hymnIndex[matchIndex].page;
      let endPage = pdfDoc.numPages;

      for (let i = matchIndex + 1; i < hymnIndex.length; i++) {
        if (hymnIndex[i].page > startPage) {
          endPage = hymnIndex[i].page - 1;
          break;
        }
      }

      renderPages(startPage, endPage);
    }

    function jumpToHymn(numStr) {
      const matchIndex = hymnIndex.findIndex(item => item.number.toString() === numStr);
      if (matchIndex === -1) {
        alert("❌ 해당 성가번호를 찾을 수 없습니다.");
        return;
      }

      const startPage = hymnIndex[matchIndex].page;
      let endPage = pdfDoc.numPages;

      for (let i = matchIndex + 1; i < hymnIndex.length; i++) {
        if (hymnIndex[i].page > startPage) {
          endPage = hymnIndex[i].page - 1;
          break;
        }
      }

      renderPages(startPage, endPage);
    }

    function renderPages(startPage, endPage) {
      const viewer = document.getElementById("pdfViewer");
      viewer.innerHTML = '';

      for (let pageNum = startPage; pageNum <= endPage; pageNum++) {
        pdfDoc.getPage(pageNum).then(page => {
          const scale = 1.6;
          const viewport = page.getViewport({ scale });

          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          canvas.width = viewport.width;
          canvas.height = viewport.height;

          page.render({ canvasContext: context, viewport });
          viewer.appendChild(canvas);
        });
      }
    }

    function openBookmarkPopup() {
      loadBookmarks();
      updateBookmarkList();
      document.getElementById("bookmarkPopup").style.display = "block";
    }

    function closeBookmarkPopup() {
      document.getElementById("bookmarkPopup").style.display = "none";
    }

    function updateBookmarkList() {
      const container = document.getElementById("bookmarkList");
      container.innerHTML = ''; // 초기화

      for (let i = 0; i < 5; i++) {
        const value = bookmarks[i] || "";

        container.innerHTML += `
        <div class="bookmark-entry">
          <input id="bmInput${i}" 
                 type="text" 
                 inputmode="numeric" 
                 maxlength="3" 
                 placeholder="성가번호" 
                 value="${value}">
          <button onclick="saveBookmark(${i})" class="save-btn">저장</button>
          <button onclick="deleteBookmark(${i})" class="delete-btn">삭제</button>
          <button onclick="searchFromBookmark(${i})" class="search-btn">검색</button>
        </div>`;
      }
    }

    function saveBookmark(index) {
      const input = document.getElementById(`bmInput${index}`);
      const val = input.value.trim();
      if (/^\d{1,3}$/.test(val)) {
        bookmarks[index] = val;
        saveBookmarks();
        updateBookmarkList();
      }
    }

    function deleteBookmark(index) {
      bookmarks[index] = "";
      saveBookmarks();
      updateBookmarkList();
    }

    function searchFromBookmark(index) {
      const input = document.getElementById(`bmInput${index}`);
      const val = input.value.trim();
      if (val) {
        jumpToHymn(val);
      } else {
        alert("🔍 검색할 성가번호를 입력해주세요.");
      }
    }

    function saveBookmarks() {
      localStorage.setItem("hymnBookmarks", JSON.stringify(bookmarks));
    }

    function loadBookmarks() {
      const saved = localStorage.getItem("hymnBookmarks");
      if (saved) {
        bookmarks = JSON.parse(saved);
      }
    }

    window.addEventListener('load', () => {
      loadBookmarks();
    });
  </script>

</body>

</html>
<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì„±ê°€ 2015</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4b0082" />
  <link rel="icon" href="icon-192.png" />

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 12px;
    }

    /* ìƒë‹¨ íˆ´ë°”: í•œ ì¤„ ìœ ì§€ */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
      overflow: hidden;
    }

    .toolbar button {
      padding: 6px 10px;
      margin: 0;
      flex: 0 0 auto;
      min-width: 36px;
    }

    #searchInput {
      padding: 6px 8px;
      font-size: 1em;
      border: 1px solid #ccc;
      flex: 1 1 0;
      min-width: 80px;
    }

    #pdfViewer {
      margin-top: 16px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }

    /* ì•ˆë‚´ë¬¸ ë°•ìŠ¤ */
    .notice-box {
      display: inline-block;
      text-align: left;
      border: 1px dashed #bbb;
      background: #fafafa;
      padding: 18px 20px;
      border-radius: 10px;
      font-size: 1.05em;
      color: #555;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    }

    .notice-title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .notice-desc {
      line-height: 1.5;
    }

    canvas {
      display: inline-block;
      max-width: 100%;
      height: auto;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }

    #bookmarkPopup {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #888;
      padding: 20px 30px 20px 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      z-index: 999;
      min-width: 250px;
    }

    #bookmarkPopup .closeBtn {
      position: absolute;
      top: 8px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    .bookmark-entry {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .bookmark-entry input {
      width: 90px;
      padding: 6px;
      font-size: 1em;
      text-align: center;
      border: 1px solid #ccc;
    }

    .bookmark-entry button {
      margin-left: 6px;
      padding: 6px 10px;
      font-size: 0.9em;
      white-space: nowrap;
      min-width: 55px;
    }

    .bookmark-entry button.save-btn {
      background-color: #d0e0ff;
      border: 1px solid #a0c0ff;
    }

    .bookmark-entry button.delete-btn {
      background-color: #f0d0d0;
      border: 1px solid #e0a0a0;
    }

    .bookmark-entry button.search-btn {
      background-color: #aaccee;
      border: 1px solid #6699cc;
      font-weight: bold;
    }

    html,
    body {
      overscroll-behavior: contain;
    }

    @media (max-width: 360px) {
      .toolbar button {
        min-width: 32px;
        padding: 6px 8px;
      }

      #searchInput {
        min-width: 60px;
      }
    }
  </style>
</head>

<body>

  <!-- í•œ ì¤„ íˆ´ë°” -->
  <div class="toolbar">
    <button aria-label="ì´ì „ ì„±ê°€" onclick="stepHymn(-1)">â€¹</button>
    <input id="searchInput" type="text" onkeydown="if (event.key === 'Enter') searchHymn()">
    <button aria-label="ë‹¤ìŒ ì„±ê°€" onclick="stepHymn(1)">â€º</button>
    <button onclick="openBookmarkPopup()">ğŸ“Œ ì±…ê°ˆí”¼</button>
  </div>

  <div id="bookmarkPopup">
    <button class="closeBtn" onclick="closeBookmarkPopup()">âœ–</button>
    <h3 style="margin-top: 0;">ğŸ“Œ ì˜¤ëŠ˜ì˜ ì„±ê°€</h3>
    <div id="bookmarkList"></div>
  </div>

  <!-- ì´ˆê¸° ì•ˆë‚´ë¬¸ -->
  <div id="pdfViewer" style="padding:24px;">
    <div class="notice-box">
      <div class="notice-title">ğŸµ ì„±ê°€ ê²€ìƒ‰ ì•ˆë‚´</div>
      <div class="notice-desc">
        ì„±ê°€ë²ˆí˜¸ë‚˜ ì œëª©ì„ ì…ë ¥í•˜ê³  <b>Enter</b> í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”.<br>
        ì¢Œìš° í™”ì‚´í‘œ ë²„íŠ¼ìœ¼ë¡œ <b>ì´ì „/ë‹¤ìŒ ì„±ê°€</b>ë¡œë„ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <script src="/khymn/pdfjs/pdf.js"></script>

  <script>

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/khymn/service-worker.js", { scope: "/khymn/" })
          .then((reg) => {
            // ì´ë¯¸ ëŒ€ê¸° ì¤‘ì¸ SWê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì•ˆë‚´
            if (reg.waiting) {
              promptUpdate(reg);
            }

            // ìƒˆ SWê°€ ì„¤ì¹˜ë˜ë©´ ìƒíƒœ í™•ì¸
            reg.addEventListener("updatefound", () => {
              const newSW = reg.installing;
              if (!newSW) return;
              newSW.addEventListener("statechange", () => {
                if (newSW.state === "installed" && navigator.serviceWorker.controller) {
                  promptUpdate(reg);
                }
              });
            });

            // SW êµì²´ë˜ë©´ ìë™ ìƒˆë¡œê³ ì¹¨
            navigator.serviceWorker.addEventListener("controllerchange", () => {
              window.location.reload();
            });

            // (ì„ íƒ) ìˆ˜ë™ ì—…ë°ì´íŠ¸ ë²„íŠ¼ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ì „ì—­ì— ë…¸ì¶œ
            window.checkForUpdate = () => reg.update();
          })
          .catch((err) => {
            console.error("SW ë“±ë¡ ì‹¤íŒ¨:", err);
          });
      });

      function promptUpdate(reg) {
        if (confirm("ğŸ“¢ ìƒˆ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤. ì§€ê¸ˆ ì—…ë°ì´íŠ¸í• ê¹Œìš”?")) {
          reg.waiting && reg.waiting.postMessage({ type: "SKIP_WAITING" });
        }
      }
    }

    pdfjsLib.GlobalWorkerOptions.workerSrc = '/khymn/pdfjs/pdf.worker.js';

    // ìŠ¤ì™€ì´í”„ ìƒˆë¡œê³ ì¹¨ ë°©ì§€
    let touchStartY = 0;
    let isOneFinger = false;
    window.addEventListener("touchstart", function (e) {
      isOneFinger = e.touches.length === 1;
      if (isOneFinger) touchStartY = e.touches[0].clientY;
    }, { passive: true });
    window.addEventListener("touchmove", function (e) {
      if (!isOneFinger) return;
      const currentY = e.touches[0].clientY;
      if (window.scrollY === 0 && currentY > touchStartY + 10) {
        e.preventDefault();
      }
    }, { passive: false });

    let pdfDoc = null;
    let hymnIndex = [];
    let bookmarks = [];
    let lastShownNumber = null;

    pdfjsLib.getDocument("/khymn/hymnbook.pdf").promise.then(doc => {
      pdfDoc = doc;
    });

    fetch("./hymn-index-final.json")
      .then(res => res.json())
      .then(data => {
        hymnIndex = data;
      });

    function hymnExists(num) {
      return hymnIndex.some(item => item.number === num);
    }

    function searchHymn() {
      const inputRaw = document.getElementById("searchInput").value.trim();
      const input = inputRaw.toLowerCase().replace(/\s+/g, "");
      if (!input || !pdfDoc || hymnIndex.length === 0) return;

      const matchIndex = hymnIndex.findIndex(item => {
        const numberMatch = item.number.toString() === input;
        const titleMatch = item.title.replace(/\s+/g, "").toLowerCase().includes(input);
        return numberMatch || (!/^\d+$/.test(input) && titleMatch);
      });

      if (matchIndex === -1) {
        alert("âŒ í•´ë‹¹ ì„±ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      lastShownNumber = hymnIndex[matchIndex].number;

      const startPage = hymnIndex[matchIndex].page;
      let endPage = pdfDoc.numPages;
      for (let i = matchIndex + 1; i < hymnIndex.length; i++) {
        if (hymnIndex[i].page > startPage) {
          endPage = hymnIndex[i].page - 1;
          break;
        }
      }
      renderPages(startPage, endPage);
    }



    function jumpToHymn(numStr) {
      const matchIndex = hymnIndex.findIndex(item => item.number.toString() === numStr);
      if (matchIndex === -1) {
        alert("âŒ í•´ë‹¹ ì„±ê°€ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // âœ… ì…ë ¥ì¹¸ì„ í˜„ì¬ ë²ˆí˜¸ë¡œ ê°±ì‹ 
      document.getElementById("searchInput").value = String(numStr);

      // âœ… í‘œì‹œëœ ë²ˆí˜¸ ê¸°ì–µ
      lastShownNumber = hymnIndex[matchIndex].number;

      const startPage = hymnIndex[matchIndex].page;
      let endPage = pdfDoc.numPages;
      for (let i = matchIndex + 1; i < hymnIndex.length; i++) {
        if (hymnIndex[i].page > startPage) {
          endPage = hymnIndex[i].page - 1;
          break;
        }
      }
      renderPages(startPage, endPage);
    }


    function stepHymn(delta) {
      const inputEl = document.getElementById("searchInput");
      const raw = inputEl.value.trim();

      let base = parseInt(raw, 10);
      if (isNaN(base)) {
        if (lastShownNumber != null) {
          base = lastShownNumber;
        } else {
          alert("ë¨¼ì € ìˆ«ì ì„±ê°€ë¥¼ í•œ ë²ˆ ê²€ìƒ‰í•´ ì£¼ì„¸ìš”.");
          return;
        }
      }

      const next = base + delta;
      if (!hymnExists(next)) {
        alert("âŒ í•´ë‹¹ ì„±ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      inputEl.value = String(next);
      jumpToHymn(String(next));
    }

    function renderPages(startPage, endPage) {
      const viewer = document.getElementById("pdfViewer");
      viewer.innerHTML = '';
      for (let pageNum = startPage; pageNum <= endPage; pageNum++) {
        pdfDoc.getPage(pageNum).then(page => {
          const scale = 1.6;
          const viewport = page.getViewport({ scale });
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          page.render({ canvasContext: context, viewport });
          viewer.appendChild(canvas);
        });
      }
    }

    function openBookmarkPopup() {
      loadBookmarks();
      updateBookmarkList();
      document.getElementById("bookmarkPopup").style.display = "block";
    }
    function closeBookmarkPopup() {
      document.getElementById("bookmarkPopup").style.display = "none";
    }

    function updateBookmarkList() {
      const container = document.getElementById("bookmarkList");
      container.innerHTML = '';
      for (let i = 0; i < 5; i++) {
        const value = bookmarks[i] || "";
        container.innerHTML +=
          '<div class="bookmark-entry">' +
          '<input id="bmInput' + i + '" type="text" inputmode="numeric" maxlength="3" placeholder="ì„±ê°€ë²ˆí˜¸" value="' + value + '">' +
          '<button onclick="saveBookmark(' + i + ')" class="save-btn">ì €ì¥</button>' +
          '<button onclick="deleteBookmark(' + i + ')" class="delete-btn">ì‚­ì œ</button>' +
          '<button onclick="searchFromBookmark(' + i + ')" class="search-btn">ê²€ìƒ‰</button>' +
          '</div>';
      }
    }
    function saveBookmark(index) {
      const input = document.getElementById("bmInput" + index);
      const val = input.value.trim();
      if (/^\d{1,3}$/.test(val)) {
        bookmarks[index] = val;
        saveBookmarks();
        updateBookmarkList();
      }
    }
    function deleteBookmark(index) {
      bookmarks[index] = "";
      saveBookmarks();
      updateBookmarkList();
    }
    function searchFromBookmark(index) {
      const input = document.getElementById("bmInput" + index);
      const val = input.value.trim();
      if (val) {
        jumpToHymn(val);
      } else {
        alert("ğŸ” ê²€ìƒ‰í•  ì„±ê°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      }
    }
    function saveBookmarks() {
      localStorage.setItem("hymnBookmarks", JSON.stringify(bookmarks));
    }
    function loadBookmarks() {
      const saved = localStorage.getItem("hymnBookmarks");
      if (saved) {
        bookmarks = JSON.parse(saved);
      }
    }
    window.addEventListener('load', () => { loadBookmarks(); });

    /*ì¶”ê°€ë¶€ë¶„*/
    self.addEventListener("message", (event) => {
      if (event.data && event.data.type === "SKIP_WAITING") {
        self.skipWaiting();
      }
    });


  </script>
</body>

</html>
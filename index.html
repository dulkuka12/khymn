<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì„±ê°€ 2015</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4b0082" />
  <link rel="icon" href="icon-192.png" />

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 12px;
    }

    /* ìƒë‹¨ íˆ´ë°” */
    .toolbar { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    #searchInput {
      padding: 6px 8px;
      font-size: 1em;
      width: 130px;
      border: 1px solid #ccc;
    }
    button { padding: 6px 10px; margin: 0 4px; }
    .icon-btn { display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; padding:0; border:1px solid #ccc; background:#fff; border-radius:6px; cursor:pointer; }
    .icon-btn:disabled { opacity:.4; cursor:not-allowed; }
    .icon-btn.emoji { font-size:20px; line-height:1; }

    /* PDF ë·° */
    #pdfViewer {
      margin-top: 16px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
      position: relative;
      min-height: 120px;
    }
    canvas {
      display: inline-block;
      max-width: 100%;
      height: auto;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }
    #pdfHint {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font-size:.95em; opacity:.7; padding:12px;
    }

    /* ì±…ê°ˆí”¼ íŒì—… */
    #bookmarkPopup {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #888;
      padding: 20px 30px 20px 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      z-index: 999;
      min-width: 250px;
    }
    #bookmarkPopup .closeBtn {
      position: absolute; top: 8px; right: 10px;
      background: transparent; border: none; font-size: 18px; cursor: pointer;
    }
    .bookmark-entry { display:flex; align-items:center; margin-bottom:8px; }
    .bookmark-entry input {
      width: 90px; padding: 6px; font-size: 1em; text-align: center; border: 1px solid #ccc;
    }
    .bookmark-entry button { margin-left:6px; padding:6px 10px; font-size:.9em; white-space:nowrap; min-width:55px; }
    .save-btn   { background-color:#d0e0ff; border:1px solid #a0c0ff; }
    .delete-btn { background-color:#f0d0d0; border:1px solid #e0a0a0; }
    .search-btn { background-color:#aaccee; border:1px solid #6699cc; font-weight:bold; }

    /* ë°‘ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ì‹œ í™”ë©´ê°±ì‹  ë°©ì§€ */
    html, body { overscroll-behavior: contain; }
  </style>
</head>
<body>

  <!-- íˆ´ë°”: â¬…ï¸ ì…ë ¥ì¹¸ â¡ï¸ ì±…ê°ˆí”¼ -->
<div class="toolbar">
  <button id="btnPrev" class="icon-btn emoji" aria-label="ì´ì „">&#11013;</button>

  <input id="searchInput" type="text" placeholder="ì¥ìˆ˜ë‚˜ ì œëª© ì…ë ¥">

  <button id="btnNext" class="icon-btn emoji" aria-label="ë‹¤ìŒ">&#10145;</button>

  <button id="btnBookmark">ğŸ“Œ ì±…ê°ˆí”¼</button>
</div>


  <!-- ì±…ê°ˆí”¼ íŒì—… -->
  <div id="bookmarkPopup">
    <button class="closeBtn" onclick="closeBookmarkPopup()">&#10006;</button>
    <h3 style="margin-top:0;">ğŸ“Œ ì˜¤ëŠ˜ì˜ ì„±ê°€</h3>
    <div id="bookmarkList"></div>
  </div>

  <!-- PDF ë·°ì–´ + ì´ˆê¸° ì•ˆë‚´ë¬¸ -->
  <div id="pdfViewer">
    <div id="pdfHint">ì„±ê°€ë²ˆí˜¸ë‚˜ ì œëª©ì„ ì…ë ¥í•˜ê³  <b>Enter</b> í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”</div>
  </div>

  <!-- pdf.js -->
  <script src="pdfjs/pdf.js"></script>

  <script>
    // Service Worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker
          .register("/khymn/service-worker.js")
          .then(function (reg) { console.log("âœ… SW ë“±ë¡:", reg.scope); })
          .catch(function (err) { console.error("âŒ SW ì‹¤íŒ¨:", err); });
      });
    }

    // pdf.js ì›Œì»¤ (ê°€ë“œ)
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';
    } else {
      console.error('pdfjsLibê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. pdfjs/pdf.js ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
    }

    // ë°‘ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ì‹œ ìƒˆë¡œê³ ì¹¨ ë°©ì§€
    (function () {
      var touchStartY = 0, isOneFinger = false;
      window.addEventListener("touchstart", function (e) {
        isOneFinger = e.touches.length === 1;
        if (isOneFinger) touchStartY = e.touches[0].clientY;
      }, { passive: true });
      window.addEventListener("touchmove", function (e) {
        if (!isOneFinger) return;
        var currentY = e.touches[0].clientY;
        if (window.scrollY === 0 && currentY > touchStartY + 10) e.preventDefault();
      }, { passive: false });
    })();

    // ===== ìƒíƒœ/ìœ í‹¸ =====
    var pdfDoc = null;
    var hymnIndex = [];   // [{ number: 101, title: '...', page: 23 }, ...]
    var bookmarks = [];
    var currentIndex = -1;

    function norm(s) { return (s == null ? '' : String(s)).toLowerCase().replace(/\s+/g, ''); }

    // ===== ë°ì´í„° ë¡œë“œ =====
    if (window.pdfjsLib) {
      pdfjsLib.getDocument("hymnbook.pdf").promise.then(function (doc) { pdfDoc = doc; });
    }
    fetch("hymn-index-final.json")
      .then(function (r) { return r.json(); })
      .then(function (d) { hymnIndex = d || []; updatePrevNextButtons(); });

    // ===== PDF ë Œë”ë§ =====
    function renderPages(startPage, endPage) {
      var viewer = document.getElementById("pdfViewer");
      var hint = document.getElementById("pdfHint");
      if (hint) hint.style.display = "none";
      viewer.innerHTML = '';

      var pg;
      for (pg = startPage; pg <= endPage; pg++) {
        (function (pageNum) {
          pdfDoc.getPage(pageNum).then(function (page) {
            var scale = 1.6;
            var viewport = page.getViewport({ scale: scale });
            var canvas = document.createElement("canvas");
            var ctx = canvas.getContext("2d");
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            page.render({ canvasContext: ctx, viewport: viewport });
            viewer.appendChild(canvas);
          });
        })(pg);
      }
      updatePrevNextButtons();
    }

    function setCurrentByIndex(i) {
      if (i < 0 || i >= hymnIndex.length) return;
      currentIndex = i;

      var item = hymnIndex[i];
      var input = document.getElementById("searchInput");
      if (input) input.value = (item.number != null ? String(item.number) : (item.title || ""));

      var startPage = item.page;
      var endPage = pdfDoc ? pdfDoc.numPages : startPage;
      for (var j = i + 1; j < hymnIndex.length; j++) {
        if (hymnIndex[j].page > startPage) { endPage = hymnIndex[j].page - 1; break; }
      }
      if (pdfDoc) renderPages(startPage, endPage);
    }

    function ensureCurrentIndex() {
      if (currentIndex >= 0) return currentIndex;
      var inputEl = document.getElementById("searchInput");
      if (!inputEl) return -1;

      var raw = inputEl.value.trim();
      if (!raw) return -1;

      var isNum = /^\d+$/.test(raw);
      var found = -1;

      if (isNum) {
        found = hymnIndex.findIndex(function (x) { return String(x.number) === raw; });
      } else {
        var target = norm(raw);
        found = hymnIndex.findIndex(function (x) { return x.title && norm(x.title).includes(target); });
      }
      if (found >= 0) currentIndex = found;
      return currentIndex;
    }

    function updatePrevNextButtons() {
      var prev = document.getElementById("btnPrev");
      var next = document.getElementById("btnNext");
      var has = currentIndex >= 0;
      if (prev) prev.disabled = (!has || currentIndex === 0);
      if (next) next.disabled = (!has || currentIndex === hymnIndex.length - 1);
    }

    // ===== ê²€ìƒ‰/ì´ë™ (ì „ì—­ë¡œ ì§€ì •) =====
    function searchHymn() {
      var inputRaw = document.getElementById("searchInput").value.trim();
      var input = inputRaw.toLowerCase().replace(/\s+/g, "");
      if (!input || !pdfDoc || hymnIndex.length === 0) return;

      var isNum = /^\d+$/.test(inputRaw);
      var matchIndex = -1;

      if (isNum) {
        matchIndex = hymnIndex.findIndex(function (item) { return String(item.number) === input; });
      } else {
        matchIndex = hymnIndex.findIndex(function (item) {
          return item.title && item.title.replace(/\s+/g, "").toLowerCase().includes(input);
        });
      }

      if (matchIndex === -1) { alert("âŒ í•´ë‹¹ ì„±ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      setCurrentByIndex(matchIndex);
    }

    function jumpToHymn(numStr) {
      var matchIndex = hymnIndex.findIndex(function (item) { return String(item.number) === numStr; });
      if (matchIndex === -1) { alert("âŒ í•´ë‹¹ ì„±ê°€ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      setCurrentByIndex(matchIndex);
    }

    function goPrev() {
      var idx = ensureCurrentIndex();
      if (idx > 0) setCurrentByIndex(idx - 1);
      updatePrevNextButtons();
    }

    function goNext() {
      var idx = ensureCurrentIndex();
      if (idx >= 0 && idx < hymnIndex.length - 1) setCurrentByIndex(idx + 1);
      updatePrevNextButtons();
    }

    // ===== ì±…ê°ˆí”¼ =====
    function openBookmarkPopup() {
      loadBookmarks();
      updateBookmarkList();
      document.getElementById("bookmarkPopup").style.display = "block";
    }
    function closeBookmarkPopup() {
      document.getElementById("bookmarkPopup").style.display = "none";
    }
    function updateBookmarkList() {
      var container = document.getElementById("bookmarkList");
      container.innerHTML = '';

      for (var i = 0; i < 5; i++) {
        (function (idx) {
          var row = document.createElement('div');
          row.className = 'bookmark-entry';

          var inp = document.createElement('input');
          inp.id = 'bmInput' + idx;
          inp.type = 'text';
          inp.setAttribute('inputmode','numeric');
          inp.maxLength = 3;
          inp.placeholder = 'ì„±ê°€ë²ˆí˜¸';
          inp.value = bookmarks[idx] || '';

          var bSave = document.createElement('button');
          bSave.className = 'save-btn';
          bSave.textContent = 'ì €ì¥';
          bSave.addEventListener('click', function(){ saveBookmark(idx); });

          var bDel = document.createElement('button');
          bDel.className = 'delete-btn';
          bDel.textContent = 'ì‚­ì œ';
          bDel.addEventListener('click', function(){ deleteBookmark(idx); });

          var bSearch = document.createElement('button');
          bSearch.className = 'search-btn';
          bSearch.textContent = 'ê²€ìƒ‰';
          bSearch.addEventListener('click', function(){ searchFromBookmark(idx); });

          row.appendChild(inp); row.appendChild(bSave); row.appendChild(bDel); row.appendChild(bSearch);
          container.appendChild(row);
        })(i);
      }
    }
    function saveBookmark(index) {
      var val = document.getElementById('bmInput' + index).value.trim();
      if (/^\d{1,3}$/.test(val)) {
        bookmarks[index] = val; saveBookmarks(); updateBookmarkList();
      }
    }
    function deleteBookmark(index) { bookmarks[index] = ""; saveBookmarks(); updateBookmarkList(); }
    function searchFromBookmark(index) {
      var val = document.getElementById('bmInput' + index).value.trim();
      if (val) jumpToHymn(val); else alert("ğŸ” ê²€ìƒ‰í•  ì„±ê°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    }
    function saveBookmarks() { localStorage.setItem("hymnBookmarks", JSON.stringify(bookmarks)); }
    function loadBookmarks() {
      var saved = localStorage.getItem("hymnBookmarks");
      if (saved) bookmarks = JSON.parse(saved);
    }
    window.addEventListener('load', loadBookmarks);

    // ì „ì—­ ë‚´ë³´ë‚´ê¸° (ì¸ë¼ì¸ í•¸ë“¤ëŸ¬ìš©)
    window.searchHymn = searchHymn;
    window.goPrev = goPrev;
    window.goNext = goNext;
    window.openBookmarkPopup = openBookmarkPopup;
    window.closeBookmarkPopup = closeBookmarkPopup;
    window.saveBookmark = saveBookmark;
    window.deleteBookmark = deleteBookmark;
    window.searchFromBookmark = searchFromBookmark;



document.addEventListener('DOMContentLoaded', function () {
  var input = document.getElementById('searchInput');
  var prev  = document.getElementById('btnPrev');
  var next  = document.getElementById('btnNext');
  var bm    = document.getElementById('btnBookmark');

  if (input) {
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') { try { searchHymn(); } catch (err) { console.error(err); } }
    });
  }
  if (prev) prev.addEventListener('click', function(){ try { goPrev(); } catch (err) { console.error(err); } });
  if (next) next.addEventListener('click', function(){ try { goNext(); } catch (err) { console.error(err); } });
  if (bm)   bm.addEventListener('click', function(){ try { openBookmarkPopup(); } catch (err) { console.error(err); } });
});



  </script>
</body>
</html>
